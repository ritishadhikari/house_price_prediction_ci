services:
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    ports:
      - 5555:5000
    options: >
      --health-cmd="curl --fail http://localhost:5000/api/2.0/mlflow/experiments/list || exit 1"
      --health-interval=5s
      --health-timeout=3s
      --health-retries=10
      --entrypoint "/bin/sh -c" 
      "mlflow server --host 0.0.0.0 --backend-store-uri sqlite:///mlflow.db --default-artifact-root /tmp/mlruns"

steps:
  
  - name: Checkout Code
    uses: actions/checkout@v5
  
  - name: Setup Python
    uses: actions/setup-python@v6
    with:
      python-version: '3.11.5'
  
  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    
  - name: Run Data Processing
    run: |
      python src/data/run_processing.py \
      --input data/raw/house_data.csv \
      --output data/processed/cleaned_house_data.csv

  - name: Do Feature Engineering
    run: |
      python src/features/engineer.py \
      --input data/processed/cleaned_house_data.csv \
      --output data/featured_house_data.csv \
      --preprocessor models/trained/preprocessor.pkl
      
  # This step waits for the MLflow service to pass its health check automatically.
  - name: Train the Model
    run: |
      python src/models/train_model.py \
      --config configs/model_config.yaml \
      --data data/processed/featured_house_data.csv \
      --models-dir models \
      --mlflow-tracking-uri http://localhost:5555